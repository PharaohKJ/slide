![logo](./logo.png "とあるインフラエンジニアの開発環境")### A Web Infrastructure Engineer's Development Environment\- kanazawa.rb meetup #21 #kzrb ----## (; ･`д･´)　誰だお前！？--+ twitter  - [@libero_18](https://twitter.com/libero_18)+ github  - [libero18](https://github.com/libero18)+ Web系のインフラエンジニア  - 最近、やってること    * [対サイバー攻撃アラートサービス：SiteVisor (サイトバイザー)](http://sitevisor.jp/)の環境構築をansibleで自動化<div style="margin-left: auto; width: 50%; height: auto;" />[![SiteVisor](./SiteVisor.png "SiteVisor")](http://www.youtube.com/watch?v=3u5u5A8_SE0)</div>    * [jqGrid](http://jqgrid.com/) + [izawa/rackplan.js](https://github.com/izawa/rackplan.js) などを利用して運用系ドキュメント作成--+ 最近、興味あるもの  - [rebuildfm](http://rebuild.fm/)  - Docker & Packer & Vagrant  - Ansible / Chef  - Serverspec & Specinfra  - sensu  - 自働化    * Infrastructure as Code    * Continuous Integration    * Continuous Delivery  - Go+ その他  - [電子書籍 「サムライ・エピソード」](http://tatsu-zine.com/books/samurai-episodes) (達人出版会)    * "第11章　Agile への取り組みから生まれた不思議な「縁」" を書きました---### 本日、お話したいと思っていること+ 普段使っているツールを紹介  - anyenv  - Ansible---# anyenv--+ \*\*env系の簡易マネージャ  - 開発者は [@riywo](https://twitter.com/riywo) さん  - 以下をまとめて管理することができる (2014/05 現在)    * denv ( dlang / D )    * goenv ( golang / Go )    * jenv ( Java )    * luaenv ( Lua )    * ndenv ( node.js )    * phpenv ( PHP )    * plenv ( Perl )    * pyenv ( Python )    * rbenv ( Ruby )--### \*\*shenv の設定```shell:export PATH="$HOME/.rbenv/bin:$PATH"eval "$(rbenv init -)"export PATH="$HOME/.goenv/bin:$PATH"eval "$(goenv init -)"export PATH="$HOME/.pyenv/bin:$PATH"eval "$(pyenv init -)"```↓```shell:export PATH="$HOME/.anyenv/bin:$PATH"eval "$(anyenv init -)"```+ 設定がひとつに  - 新たな設定追加が不要で、簡単に別の言語環境を導入することができます--### インストール+ \*\*envのインストール```shell:❯❯❯ anyenv install rbenv❯❯❯ anyenv install goenv❯❯❯ anyenv install pyenv```+ \*\*envで任意のものをインストール```shell:❯❯❯ rbenv install 2.1.2```--### 実際にバージョン確認をしてみると？```shell:❯❯❯ anyenv versiongoenv: couldn't find any version specified for usegoenv:pyenv: system (set by /Users/nakajima/.anyenv/envs/pyenv/version)rbenv: 2.1.2 (set by /Users/nakajima/.anyenv/envs/rbenv/version)❯❯❯ anyenv versionsgoenv:pyenv:* system (set by /Users/nakajima/.anyenv/envs/pyenv/version)rbenv:  system  2.1.0  2.1.1* 2.1.2 (set by /Users/nakajima/.anyenv/envs/rbenv/version)```+ Go はインストールされていない+ Python は System 標準のものを利用している+ Ruby は rbenv で 2.1.2 がインストールされている--### znz/anyenv-updateでアップデート```shell:❯❯❯ anyenv updateUpdating 'anyenv'...Already up-to-date.Updating 'goenv'...Already up-to-date.Updating 'pyenv'...remote: Counting objects: 19, done.remote: Compressing objects: 100% (17/17), done.... 長すぎるので省略 ...Updating 'rbenv'...Already up-to-date.Updating 'rbenv-binstubs'...Already up-to-date.```+ コマンドひとつで簡単にアップデートができます  - anyenv & anyenv のプラグイン  - \*\*env & \*\*env のプラグイン--### znz/anyenv-updateでgitコマンド```shell:❯❯❯ anyenv git gcRun git in 'anyenv'...Counting objects: 114, done.Delta compression using up to 4 threads.Compressing objects: 100% (101/101), done.Writing objects: 100% (114/114), done.Total 114 (delta 40), reused 0 (delta 0)Run git in 'anyenv-git'...Counting objects: 29, done.Delta compression using up to 4 threads.Compressing objects: 100% (26/26), done.Writing objects: 100% (29/29), done.Total 29 (delta 8), reused 0 (delta 0)Run git in 'anyenv-update'...... 長すぎるので省略 ...```+ コマンドひとつで各リポジトリ内にある不要なオブジェクトを削除したりできます  - anyenv リポジトリ & 各 anyenv プラグインのリポジトリ  - \*\*env リポジトリ & 各 \*\*env プラグインのリポジトリ--### aereal/anyenv-execでサブコマンド```shell:❯❯❯ anyenv exec --versiongoenv 0.0.4pyenv 0.4.0-20140404-28-g8851acdrbenv 0.4.0-97-gfe0b243❯❯❯ anyenv exec rehash```+ \*\*env rehash のようなサブコマンドをまとめて実行できます--### まとめ<div style="text-align: left;" \>様々な言語の環境をひとつの方法で簡単に構築でき、  各種プラグインなどもまとめて簡単にアップデートできる</div>  それが anyenv--### 参考+ riywo/anyenv  - [https://github.com/riywo/anyenv](https://github.com/riywo/anyenv)+ znz/anyenv-update  - [https://github.com/znz/anyenv-update](https://github.com/znz/anyenv-update)+ anyenv-git  - [https://github.com/znz/anyenv-git](https://github.com/znz/anyenv-git)+ anyenv-exec  - [https://github.com/aereal/anyenv-exec](https://github.com/aereal/anyenv-exec)+ anyenvという\*\*env系の簡易マネージャを作った  - [http://blog.riywo.com/2013/06/22/155804](http://blog.riywo.com/2013/06/22/155804)+ anyenvで開発環境を整える  - [http://qiita.com/luckypool/items/f1e756e9d3e9786ad9ea](http://qiita.com/luckypool/items/f1e756e9d3e9786ad9ea)---# Ansible--## Ansible とは+ サーバ構成管理ツール  - ≒便利で汎用的なシェルスクリプト  - OSの初期設定やミドルウェアのインストール/設定を動く手順書として記述することができます  - 最近だと Ansible を利用して OS Xを管理する [osxc](http://osxc.github.io/) ってのもあります    * インストール用のスクリプトで Ansible を pip install して準備された Playbook から Homebrew などを利用している    * Homebrew + Homebrew-cask よりも自由度が高く、 Boxen よりも簡単に使えそう--+ ローカルホストからリモートホストに Push して実行するので、リモートホストにエージェントは不要です  - Python と ssh が利用できる環境であれば簡単に使えます  - 複数ホストに対して同時に実行することもできます+ Python 製のツールだけど、実際に利用するためには yaml を書けてコマンドラインでサーバの作業ができれば大丈夫+ 外部 DSL だけど自作の module を利用する機能があるので、自由度は高い  - プログラムならこんな感じで書けるのに、テンプレートエンジン(jinja2)だとどうすりゃいいの？とか困ったことはあったｗ  - つまり、複雑な処理をしたければ module を書けよって話--+ できないこと  - OSのインストール    * 自動化するにはクラウドとか利用してAPI経由でインスタンスを作成し、そのインスタンスに向けて Ansible を実行するような Vagrantfile とかを書く必要がある--+ やらないほうが良いこと  - プログラムのデプロイ    * ≒便利で汎用的なシェルスクリプトなので、デプロイの手順も書けるが素直にデプロイツールを利用する方が良い    * 当然、 DB はマイグレーションツールを利用する方が良い      * 実際には Ansible からデプロイツールやマイグレーションツールを動かすコマンドを実行する      * cap development deploy とか      * alembic upgrade head など--### module+ module が処理していること  - 標準入力でオプションを受け取る  - 標準出力で実行結果を返す    * 入出力に JSON フォーマットなどを利用しているので、他の言語でも作れます    * 要するにテキスト処理なので、シェルスクリプトでも module を作れるんですよねー--+ 標準で用意された module はこんな感じで使えます```bash❯❯❯ ansible -i hosts 192.168.100.20 -m ping192.168.100.20 | success >> {    "changed": false,     "ping": "pong"}❯❯❯ ansible -i hosts 192.168.100.21 -m raw -a "uname -a"192.168.100.21 | success | rc=0 >>2.6.32-431.el6.x86_64❯❯❯ ansible -i hosts 192.168.100.22 -m raw -a "sudo yum install -y python-simplejson"```--+ シェルスクリプトで書いていた処理に、実行に必要な引数を渡して処理結果が画面出力されてるものと考えればわかりやすいかも```bash❯❯❯ ansible -i hosts 192.168.100.21 -m raw -a "uname -a"```↓```bash❯❯❯ ansible -m raw -a "uname -a" -i hosts 192.168.100.21```≒```bash❯❯❯ sh ./remote_host_uname.sh 192.168.100.21```↓```bash処理結果が出力される2.6.32-431.el6.x86_64```+ ansible → sh+ -m raw -a "uname -a" -i hosts → ./remote_host_uname.sh--### Playbook+ module などを利用する手順をまとめて yaml で書いたもの+ ansible-playbook ファイル名 で実行する+ 設定ファイルを配置や置換したり、サービスの再起動などサーバを構築するうえで必要な手順を記載する+ yum module を利用して指定パッケージをインストールする場合、こんな感じで書けます```- hosts: myserver  user: vagrant  sudo: yes  tasks:    - name: install apache      action: yum pkg=httpd state=installed    - name: install mysql      action: yum pkg=mysql state=installed```--+ 一部抜粋した部分をサーバ構築の手順書として書いたものと比較するとわかりやすいかも```- hosts: myserver  user: vagrant  sudo: yes  tasks:    - name: install apache      action: yum pkg=httpd state=installed    - name: install mysql      action: yum pkg=mysql state=installed```↓```  sudo: yes  tasks:    - name: install apache      action: yum pkg=httpd state=installed    - name: install mysql      action: yum pkg=mysql state=installed```≒```手順1. Apache をインストールするsudo yum install httpd手順2. MySQL をインストールするsudo yum install mysql```--### まとめ<div style="text-align: left;" \>シェルスクリプトを動く手順書として作成するのは大変だが  それを容易かつ汎用的な文書に変換し、再利用も可能にする</div>  それが Ansible--### 参考+ Ansible Tutorial  - [http://yteraoka.github.io/ansible-tutorial/](http://yteraoka.github.io/ansible-tutorial/)+ 不思議の国のAnsible  - [http://demand-side-science.jp/blog/2014/ansible-in-wonderland-01/](http://demand-side-science.jp/blog/2014/ansible-in-wonderland-01/)+ 入門Ansible  - [http://www.slideshare.net/takushimizu/ansible-26200860](http://www.slideshare.net/takushimizu/ansible-26200860)+ Qiita (tag:Ansible)  - [http://qiita.com/search?q=tag%3AAnsible&sort=&utf8=%E2%9C%93](http://qiita.com/search?q=tag%3AAnsible&sort=&utf8=%E2%9C%93)---Todo: Serverspec--![進捗ダメです](http://sngk.net/LKLLfU/img1)書きたかったけど間に合わんかったｗ---### 本日、お伝えしたかったこと---+ anyenv  - 様々な環境で同じ方法を使って管理できるものをプラットフォームに選択しておくと、○○を使って××をする場合のノウハウがそこに集約されるので、開発環境と本番環境との差異で新たな学習コストなどが発生しにくくなり便利--+ Ansible  - 再利用可能なツールを日常的な習慣に取り入れてあると、同じものをインスタントに複製ができ、自働化の恩恵で容易に成果を得ることができるので便利--+ Serverspec  - (資料は間に合いませんでしたが・・・)再利用可能なツールをインスタントに複製したあとの確認作業も自働化しておくと、本来の目的であるコードを書くことに集中ができ、確認作業に人の判断が入らないので既知の観点による確認漏れが発生しないので仕事の精度が高くなって便利---## ありがとうございました